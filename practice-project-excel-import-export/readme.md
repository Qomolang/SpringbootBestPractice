
### 需求

#### 些微的行变更
有时候，导出形式A比导出形式B只多了一列，尽量保持这种灵活性

#### 导入校验
1. 表头校验
2. 导入量校验
3. 存量校验：与数据库重复的数据在导入时就要校验，不能依赖上游幂等（不允许走到数据库插入那一步）
4. 格式校验

#### 错误处理
导入时，错误信息显示行号

### 技术
本模块基于easyExcel，旨在提供通用、异步、高性能的导入导出业务模板

不提供同步导入，只提供异步导入。导入过程中的校验、错误处理（另外生成excel）、插入，均为比较耗时的动作，很容易出现问题。

#### 异步导出
##### 应该什么时候清除“正在异步导出“和”异步导出结果“的缓存标记？
方案一：异步轮询查到结果后，才清除“正在异步导出“的缓存标记和”异步导出结果“的缓存标记，这主要是为了区分“没有导出”，”正在导出“，”导出完毕“三种状态。
方案二：如果仅区分”导出完成”和”没有导出结果“，可以在异步导出后就清除“正在异步导出“标记，在异步轮询查到结果后，删除”异步导出结果“的缓存标记。
* 方案二的主要好处是：因为异步轮询是前端发起的，方案二可以避免一些前后端配合失误导致异步轮询中断 从而出现的一些奇怪场景。比如前端忘记添加异步轮询，用户再次点击导入按钮，会一直显示“正在导出”

再考虑到用户关闭页面的场景（假设缓存永不过期）：
* 假设是方案一，用户在点击导出后，立刻关闭页面，添加了某些数据，等24h后再打开。用户再次点击导出，“正在异步导出“仍然存在，会显示“已有导出任务，请等待”，同时前端触发轮询，查询到上一次的导出结果，返回给了用户。造成导出时间特别长的现象
* 方案二也有这个问题，用户24h后再次进入页面点击导出，“异步导出结果“标记仍然存在，会显示“没有导出结果”，之后获得上一次的excel

因此，提出方案三
方案三：“正在异步导出“的标记，在异步导出后就清除；“异步导出结果”的缓存的清除时间，设定在“没有正在导出的任务后”和“进入异步执行前”之间，也就是在异步导入前期
* 当用户24后再打开页面并点击导出，“正在异步导出“标记不存在，可以顺畅点击导出按钮，“异步导出结果”会被删除也不存在，轮询不会获得上次结果。总的来说，用户只有停留在这个页面才会获得结果

但方案三只能获得两种结果状态，能不能让方案三有三种结果状态？
这时候要回过头来看，我们刚才默认的一个事情，即”轮询结果查询接口，如何处理“正在异步导出“和”异步导出结果“两个标记“，刚刚都默认采用递进式

##### 轮询结果查询接口，如何处理“正在异步导出“和”异步导出结果“两个标记
如果是先查”是否导出中”，再查“是否导入结束”
1. 先查“正在异步导出flag”，false则返回“没有导出”，true则继续
2. 再查“异步导出结果flag”，false则返回“正在导出”，true则返回结果

可以反转过来
1. 先查“异步导出结果flag”，非空则返回“导入完毕”，空则继续
2. 再查“正在异步导出flag”，非空则返回“导入中”，空返回“未导入”

或者等效地替换成组合式
1. 同时查出来”正在异步导出flag“为ingFlag，”异步导出结果flag“为resultFlag
2. ingFlag==true resultFlag==true，不可能
3. ingFlag==false resultFlag==true，导入完毕
4. ingFlag==true resultFlag==false，导入中
5. ingFlag==false resultFlag==false，未导入

#### 导入导出模式
导入导出根据业务要求不同，模式可以有很多，比如：

对于导入数据，可以分为两种：
1. 固定式，excel列固定
2. 动态式，excel列不固定，比如课程表excel的列可以是班级

对于表头，可以分为两种：
1. 简单单行表头
2. 复杂多行表头

对于数据有效性，可以分为三种：
1. 无限制
2. 连续限制，数据可以在一定范围内任意取值
3. 离散限制，数据仅可取某些固定值

对于校验，可以分两种：
1. 表头校验，从宽到严格依次为 包含目标表头即可/内容严格一致/顺序严格一致
2. 内容校验，即数据有效性

对于导入错误提示，可以分为两种：
1. excel错误提示，又可以分为标红和仅提示错误行
2. 前端错误提示

对于导入结果，也可以分为两种：
1. 尽力式，能导入尽量导入
2. 事务式，要么全成功，要么全失败

